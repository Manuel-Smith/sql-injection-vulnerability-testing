const router = require('express').Router();
const pool = require('../db');

router.get('/', async (req, res) => {
    try {
        const appointmentId = req.query.id;

        if (!appointmentId) {
            return res.status(400).json({ error: 'Appointment ID is required.' });
        }

        const appointmentQuery = `
            SELECT
                doctors.firstname AS doctorname,
                doctors.specialization,
                appointments.appointmentdate,
                appointments.notes,
                patients.firstname AS patientname,
                patients.dateofbirth
            FROM
                appointments
            INNER JOIN
                doctors ON doctors.doctorid = appointments.doctorid
            INNER JOIN
                patients ON patients.patientid = appointments.patientid
            WHERE
                appointmentid = ${appointmentId}
        `;

        const result = await pool.query(appointmentQuery);

        const appointmentArray = result.rows.map(row => {
            const timestamp = row.appointmentdate;
            const dateObject = new Date(timestamp);

            const dob = new Date(row.dateofbirth);
            const currentDate = new Date();

            const ageInMilliseconds = currentDate - dob;
            const ageInYears = ageInMilliseconds / (1000 * 60 * 60 * 24 * 365.25);
            const roundedAge = Math.floor(ageInYears);

            const extractedDate = dateObject.toISOString().split('T')[0];
            const extractedTime = dateObject.toISOString().split('T')[1].split('Z')[0];

            return {
                doctorName: row.doctorname,
                patientName: row.patientname,
                patientAge: roundedAge,
                specialization: row.specialization,
                appointmentDate: extractedDate,
                appointmentTime: extractedTime,
                reason: row.notes
            };
        });

        res.status(200).json(appointmentArray);
    } catch (error) {
        console.error(error);
        let errorMessage = `${error.message}`
        res.status(500).json({ error: errorMessage });
        console.log(errorMessage);
    }
});

module.exports = router;
